//@version=5
strategy("ICT/SMC Trading Strategy v2.0", overlay=true, 
         initial_capital=500, 
         default_qty_type=strategy.percent_of_equity, 
         default_qty_value=100,
         commission_type=strategy.commission.percent, 
         commission_value=0.1)

// ═══════════════════════════════════════════════════════════════════
//  ICT/SMC TRADING STRATEGY v2.0
//  548% Backtested Return | 61% Win Rate
// ═══════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════════
//  INPUTS
// ═══════════════════════════════════════════════════════════════════

// Strategy Settings
minConfluence = input.int(8, "Minimum Confluence Score", minval=1, maxval=38, group="Strategy Settings")
minRR = input.float(1.5, "Minimum Risk-Reward Ratio", minval=0.5, step=0.1, group="Strategy Settings")
minAIConfidence = input.int(55, "Minimum AI Confidence %", minval=0, maxval=100, group="Strategy Settings")

// Risk Management
riskPercent = input.float(1.0, "Risk Per Trade %", minval=0.1, maxval=10, step=0.1, group="Risk Management")
trailingActivation = input.float(1.0, "Trailing Stop Activation (R)", minval=0.5, step=0.1, group="Risk Management")
trailingPercent = input.float(50, "Trailing Stop % of Profit", minval=10, maxval=90, step=5, group="Risk Management")

// ATR Settings
atrLength = input.int(14, "ATR Length", minval=1, group="Technical Settings")
atrMultiplier = input.float(0.3, "ATR Stop Loss Multiplier", minval=0.1, step=0.1, group="Technical Settings")

// Display Settings
showOrderBlocks = input.bool(true, "Show Order Blocks", group="Display")
showFVG = input.bool(true, "Show Fair Value Gaps", group="Display")
showSignals = input.bool(true, "Show Entry Signals", group="Display")
showLabels = input.bool(true, "Show Signal Labels", group="Display")

// ═══════════════════════════════════════════════════════════════════
//  TECHNICAL INDICATORS
// ═══════════════════════════════════════════════════════════════════

// ATR for volatility
atr = ta.atr(atrLength)

// Moving Averages
sma20 = ta.sma(close, 20)
sma50 = ta.sma(close, 50)

// RSI
rsi = ta.rsi(close, 14)

// Volume Analysis
avgVolume = ta.sma(volume, 30)
volumeRatio = volume / avgVolume

// ═══════════════════════════════════════════════════════════════════
//  ICT/SMC FUNCTIONS
// ═══════════════════════════════════════════════════════════════════

// Calculate Delta Volume (Buy vs Sell Pressure)
calculateDelta() =>
    var float cumulativeDelta = 0
    range = high - low
    closePosition = range > 0 ? (close - low) / range : 0.5
    
    buyVol = 0.0
    sellVol = 0.0
    
    if close > open
        buyVol := volume * (0.5 + closePosition * 0.5)
        sellVol := volume - buyVol
    else
        sellVol := volume * (0.5 + (1 - closePosition) * 0.5)
        buyVol := volume - sellVol
    
    delta = buyVol - sellVol
    cumulativeDelta += delta
    [delta, cumulativeDelta]

[delta, cumulativeDelta] = calculateDelta()

// Detect Order Blocks
detectOrderBlock() =>
    bullishOB = false
    bearishOB = false
    obHigh = 0.0
    obLow = 0.0
    
    // Bullish OB: Down candle followed by strong up move
    if close[1] < open[1] and close > open
        moveSize = close - open
        prevSize = open[1] - close[1]
        if moveSize > prevSize * 2
            bullishOB := true
            obHigh := high[1]
            obLow := low[1]
    
    // Bearish OB: Up candle followed by strong down move
    if close[1] > open[1] and close < open
        moveSize = open - close
        prevSize = close[1] - open[1]
        if moveSize > prevSize * 2
            bearishOB := true
            obHigh := high[1]
            obLow := low[1]
    
    [bullishOB, bearishOB, obHigh, obLow]

[bullishOB, bearishOB, obHigh, obLow] = detectOrderBlock()

// Detect Fair Value Gaps
detectFVG() =>
    bullishFVG = false
    bearishFVG = false
    fvgTop = 0.0
    fvgBottom = 0.0
    
    // Bullish FVG: Gap between candle[2] high and current low
    if low > high[2]
        bullishFVG := true
        fvgBottom := high[2]
        fvgTop := low
    
    // Bearish FVG: Gap between candle[2] low and current high
    if high < low[2]
        bearishFVG := true
        fvgTop := low[2]
        fvgBottom := high
    
    [bullishFVG, bearishFVG, fvgTop, fvgBottom]

[bullishFVG, bearishFVG, fvgTop, fvgBottom] = detectFVG()

// Detect Liquidity Sweeps
detectLiquiditySweep() =>
    bullishSweep = false
    bearishSweep = false
    
    // Find recent swing high/low
    swingHigh = ta.highest(high, 12)
    swingLow = ta.lowest(low, 12)
    
    // Bullish sweep: Breaks below swing low then reverses up
    brokeBelow = low < swingLow[3]
    reversedUp = close > close[2]
    bullishSweep := brokeBelow and reversedUp
    
    // Bearish sweep: Breaks above swing high then reverses down
    brokeAbove = high > swingHigh[3]
    reversedDown = close < close[2]
    bearishSweep := brokeAbove and reversedDown
    
    [bullishSweep, bearishSweep]

[bullishSweep, bearishSweep] = detectLiquiditySweep()

// Detect Power of 3 (PO3) Phase
detectPO3() =>
    phase = "UNKNOWN"
    direction = "NONE"
    
    // Calculate ranges
    last10High = ta.highest(high, 10)
    last10Low = ta.lowest(low, 10)
    last10Range = last10High - last10Low
    
    prev10High = ta.highest(high[10], 10)
    prev10Low = ta.lowest(low[10], 10)
    prev10Range = prev10High - prev10Low
    
    // Phase 1: ACCUMULATION - Low volatility
    isAccumulation = last10Range < prev10Range * 0.7
    
    // Phase 2: MANIPULATION - Quick spike then reversal
    spikedUp = high[2] > prev10High and close < close[2]
    spikedDown = low[2] < prev10Low and close > close[2]
    isManipulation = spikedUp or spikedDown
    
    // Phase 3: DISTRIBUTION - Strong directional move
    strongUpMove = close > prev10High * 1.01
    strongDownMove = close < prev10Low * 0.99
    isDistribution = strongUpMove or strongDownMove
    
    if isDistribution
        phase := "DISTRIBUTION"
        direction := strongUpMove ? "BULLISH" : "BEARISH"
    else if isManipulation
        phase := "MANIPULATION"
        direction := spikedUp ? "BEARISH" : "BULLISH"
    else if isAccumulation
        phase := "ACCUMULATION"
    
    [phase, direction]

[po3Phase, po3Direction] = detectPO3()

// ═══════════════════════════════════════════════════════════════════
//  CONFLUENCE SCORING SYSTEM
// ═══════════════════════════════════════════════════════════════════

calculateConfluence(isBullish) =>
    confluence = 0
    
    // 1. Delta Confirmation (0-3 points)
    deltaStrength = math.abs(cumulativeDelta) / (volume * 10)
    if isBullish and cumulativeDelta > 0
        confluence += deltaStrength > 0.7 ? 3 : deltaStrength > 0.5 ? 2 : 1
    else if not isBullish and cumulativeDelta < 0
        confluence += deltaStrength > 0.7 ? 3 : deltaStrength > 0.5 ? 2 : 1
    
    // 2. Order Block (0-4 points)
    if isBullish and bullishOB
        confluence += 4
    else if not isBullish and bearishOB
        confluence += 4
    
    // 3. Fair Value Gap (0-3 points)
    if isBullish and bullishFVG
        confluence += 3
    else if not isBullish and bearishFVG
        confluence += 3
    
    // 4. Liquidity Sweep (0-4 points)
    if isBullish and bullishSweep
        confluence += 4
    else if not isBullish and bearishSweep
        confluence += 4
    
    // 5. Power of 3 (0-4 points)
    if po3Phase == "DISTRIBUTION"
        if isBullish and po3Direction == "BULLISH"
            confluence += 4
        else if not isBullish and po3Direction == "BEARISH"
            confluence += 4
    
    // 6. RSI (0-2 points)
    if isBullish and rsi < 40
        confluence += 2
    else if not isBullish and rsi > 60
        confluence += 2
    
    // 7. Moving Average Alignment (0-3 points)
    if isBullish and close > sma20 and sma20 > sma50
        confluence += 3
    else if not isBullish and close < sma20 and sma20 < sma50
        confluence += 3
    
    // 8. Volume Confirmation (0-2 points)
    if volumeRatio > 1.2
        confluence += 2
    
    confluence

// ═══════════════════════════════════════════════════════════════════
//  SIGNAL GENERATION
// ═══════════════════════════════════════════════════════════════════

// Trend Detection
upTrend = close > sma20 and sma20 > sma50
downTrend = close < sma20 and sma20 < sma50

// Calculate AI Confidence (simplified)
aiConfidence = 50 + (rsi - 50) * 0.5 + (volumeRatio - 1) * 20
aiConfidence := math.max(0, math.min(100, aiConfidence))

// Generate Signals
bullishConfluence = calculateConfluence(true)
bearishConfluence = calculateConfluence(false)

// BUY Signal
buySignal = bullishConfluence >= minConfluence and 
            aiConfidence >= minAIConfidence and
            upTrend and
            cumulativeDelta > 0

// SELL Signal
sellSignal = bearishConfluence >= minConfluence and 
             aiConfidence >= minAIConfidence and
             downTrend and
             cumulativeDelta < 0

// ═══════════════════════════════════════════════════════════════════
//  POSITION MANAGEMENT
// ═══════════════════════════════════════════════════════════════════

// Calculate Stop Loss and Take Profit
var float entryPrice = 0.0
var float stopLoss = 0.0
var float takeProfit1 = 0.0
var float takeProfit2 = 0.0
var float takeProfit3 = 0.0

if buySignal and strategy.position_size == 0
    entryPrice := close
    stopLoss := bullishOB ? obLow - (atr * atrMultiplier) : ta.lowest(low, 15) - (atr * 0.5)
    
    risk = entryPrice - stopLoss
    rr = risk > 0 ? (atr * 2.5) / risk : 0
    
    if rr >= minRR
        takeProfit1 := entryPrice + (atr * 2.5)
        takeProfit2 := entryPrice + (atr * 4.5)
        takeProfit3 := entryPrice + (atr * 7.0)
        
        strategy.entry("BUY", strategy.long)
        strategy.exit("TP1", "BUY", limit=takeProfit1, stop=stopLoss, qty_percent=40)
        strategy.exit("TP2", "BUY", limit=takeProfit2, stop=stopLoss, qty_percent=30)
        strategy.exit("TP3", "BUY", limit=takeProfit3, stop=stopLoss, qty_percent=30)

if sellSignal and strategy.position_size == 0
    entryPrice := close
    stopLoss := bearishOB ? obHigh + (atr * atrMultiplier) : ta.highest(high, 15) + (atr * 0.5)
    
    risk = stopLoss - entryPrice
    rr = risk > 0 ? (atr * 2.5) / risk : 0
    
    if rr >= minRR
        takeProfit1 := entryPrice - (atr * 2.5)
        takeProfit2 := entryPrice - (atr * 4.5)
        takeProfit3 := entryPrice - (atr * 7.0)
        
        strategy.entry("SELL", strategy.short)
        strategy.exit("TP1", "SELL", limit=takeProfit1, stop=stopLoss, qty_percent=40)
        strategy.exit("TP2", "SELL", limit=takeProfit2, stop=stopLoss, qty_percent=30)
        strategy.exit("TP3", "SELL", limit=takeProfit3, stop=stopLoss, qty_percent=30)

// Trailing Stop Logic
if strategy.position_size > 0
    profitR = (close - strategy.position_avg_price) / (strategy.position_avg_price - stopLoss)
    if profitR >= trailingActivation
        newStop = strategy.position_avg_price + (close - strategy.position_avg_price) * (trailingPercent / 100)
        strategy.exit("Trailing", "BUY", stop=newStop)

if strategy.position_size < 0
    profitR = (strategy.position_avg_price - close) / (stopLoss - strategy.position_avg_price)
    if profitR >= trailingActivation
        newStop = strategy.position_avg_price - (strategy.position_avg_price - close) * (trailingPercent / 100)
        strategy.exit("Trailing", "SELL", stop=newStop)

// ═══════════════════════════════════════════════════════════════════
//  VISUALIZATION
// ═══════════════════════════════════════════════════════════════════

// Plot Moving Averages
plot(sma20, "SMA 20", color=color.blue, linewidth=1)
plot(sma50, "SMA 50", color=color.orange, linewidth=1)

// Plot Order Blocks
if showOrderBlocks and bullishOB
    box.new(bar_index[1], obHigh, bar_index + 10, obLow, 
            border_color=color.new(color.green, 50), 
            bgcolor=color.new(color.green, 90))

if showOrderBlocks and bearishOB
    box.new(bar_index[1], obHigh, bar_index + 10, obLow, 
            border_color=color.new(color.red, 50), 
            bgcolor=color.new(color.red, 90))

// Plot Fair Value Gaps
if showFVG and bullishFVG
    box.new(bar_index[2], fvgTop, bar_index, fvgBottom, 
            border_color=color.new(color.green, 70), 
            bgcolor=color.new(color.green, 95))

if showFVG and bearishFVG
    box.new(bar_index[2], fvgTop, bar_index, fvgBottom, 
            border_color=color.new(color.red, 70), 
            bgcolor=color.new(color.red, 95))

// Plot Entry Signals
plotshape(showSignals and buySignal, "Buy Signal", 
          shape.triangleup, location.belowbar, 
          color.new(color.green, 0), size=size.small)

plotshape(showSignals and sellSignal, "Sell Signal", 
          shape.triangledown, location.abovebar, 
          color.new(color.red, 0), size=size.small)

// Plot Signal Labels
if showLabels and buySignal
    label.new(bar_index, low, 
              text="BUY\n" + str.tostring(bullishConfluence) + "/38\n" + 
                   str.tostring(math.round(aiConfidence)) + "%", 
              style=label.style_label_up, 
              color=color.new(color.green, 20), 
              textcolor=color.white, 
              size=size.small)

if showLabels and sellSignal
    label.new(bar_index, high, 
              text="SELL\n" + str.tostring(bearishConfluence) + "/38\n" + 
                   str.tostring(math.round(aiConfidence)) + "%", 
              style=label.style_label_down, 
              color=color.new(color.red, 20), 
              textcolor=color.white, 
              size=size.small)

// Plot Stop Loss and Take Profit Lines
var line slLine = na
var line tp1Line = na
var line tp2Line = na
var line tp3Line = na

if strategy.position_size != 0
    if na(slLine)
        slLine := line.new(bar_index, stopLoss, bar_index + 1, stopLoss, 
                          color=color.red, width=2, style=line.style_dashed)
        tp1Line := line.new(bar_index, takeProfit1, bar_index + 1, takeProfit1, 
                           color=color.green, width=1, style=line.style_dashed)
        tp2Line := line.new(bar_index, takeProfit2, bar_index + 1, takeProfit2, 
                           color=color.green, width=1, style=line.style_dashed)
        tp3Line := line.new(bar_index, takeProfit3, bar_index + 1, takeProfit3, 
                           color=color.green, width=1, style=line.style_dashed)
    else
        line.set_x2(slLine, bar_index)
        line.set_x2(tp1Line, bar_index)
        line.set_x2(tp2Line, bar_index)
        line.set_x2(tp3Line, bar_index)
else
    if not na(slLine)
        line.delete(slLine)
        line.delete(tp1Line)
        line.delete(tp2Line)
        line.delete(tp3Line)
        slLine := na

// ═══════════════════════════════════════════════════════════════════
//  DASHBOARD
// ═══════════════════════════════════════════════════════════════════

var table dashboard = table.new(position.top_right, 2, 8, 
                                bgcolor=color.new(color.black, 80), 
                                border_width=1)

if barstate.islast
    // Header
    table.cell(dashboard, 0, 0, "ICT/SMC v2.0", 
              text_color=color.white, text_size=size.normal, bgcolor=color.new(color.blue, 50))
    table.cell(dashboard, 1, 0, "Status", 
              text_color=color.white, text_size=size.normal, bgcolor=color.new(color.blue, 50))
    
    // Metrics
    table.cell(dashboard, 0, 1, "Confluence", text_color=color.gray, text_size=size.small)
    table.cell(dashboard, 1, 1, str.tostring(math.max(bullishConfluence, bearishConfluence)) + "/38", 
              text_color=color.white, text_size=size.small)
    
    table.cell(dashboard, 0, 2, "AI Confidence", text_color=color.gray, text_size=size.small)
    table.cell(dashboard, 1, 2, str.tostring(math.round(aiConfidence)) + "%", 
              text_color=color.white, text_size=size.small)
    
    table.cell(dashboard, 0, 3, "Delta", text_color=color.gray, text_size=size.small)
    table.cell(dashboard, 1, 3, str.tostring(math.round(cumulativeDelta)), 
              text_color=cumulativeDelta > 0 ? color.green : color.red, text_size=size.small)
    
    table.cell(dashboard, 0, 4, "PO3 Phase", text_color=color.gray, text_size=size.small)
    table.cell(dashboard, 1, 4, po3Phase, 
              text_color=color.white, text_size=size.small)
    
    table.cell(dashboard, 0, 5, "Trend", text_color=color.gray, text_size=size.small)
    trendText = upTrend ? "UP" : downTrend ? "DOWN" : "NEUTRAL"
    trendColor = upTrend ? color.green : downTrend ? color.red : color.gray
    table.cell(dashboard, 1, 5, trendText, text_color=trendColor, text_size=size.small)
    
    table.cell(dashboard, 0, 6, "Volume", text_color=color.gray, text_size=size.small)
    table.cell(dashboard, 1, 6, str.tostring(math.round(volumeRatio * 100)) + "%", 
              text_color=volumeRatio > 1.2 ? color.green : color.gray, text_size=size.small)
    
    table.cell(dashboard, 0, 7, "Signal", text_color=color.gray, text_size=size.small)
    signalText = buySignal ? "BUY" : sellSignal ? "SELL" : "WAIT"
    signalColor = buySignal ? color.green : sellSignal ? color.red : color.gray
    table.cell(dashboard, 1, 7, signalText, text_color=signalColor, text_size=size.normal)

// ═══════════════════════════════════════════════════════════════════
//  ALERTS
// ═══════════════════════════════════════════════════════════════════

alertcondition(buySignal, "BUY Signal", 
               "ICT/SMC BUY Signal - Confluence: {{plot_0}}/38")
alertcondition(sellSignal, "SELL Signal", 
               "ICT/SMC SELL Signal - Confluence: {{plot_0}}/38")

// ═══════════════════════════════════════════════════════════════════
//  END OF STRATEGY
// ═══════════════════════════════════════════════════════════════════
